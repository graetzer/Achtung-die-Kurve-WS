#{extends 'main.html' /} #{set title:'Play Achtung die Kurve' /} #{set
'moreScripts'} #{script id:'sockets', src:'jquery.gracefulWebSocket.js',
charset:'utf-8' /} #{script id:'game', src:'game.js', charset:'utf-8' /}
<script type="text/javascript">


	jQuery.fn.extend({
		selectText : function() {
			var text = $(this)[0];
			if($.browser.msie) {
				var range = document.body.createTextRange();
				range.moveToElementText(text);
				range.select();
			} else if($.browser.mozilla || $.browser.opera) {
				var selection = window.getSelection();
				var range = document.createRange();
				range.selectNodeContents(text);
				selection.removeAllRanges();
				selection.addRange(range);
			} else if($.browser.safari) {
				var selection = window.getSelection();
				selection.setBaseAndExtent(text, 0, text, 1);
			}
			return $(this);
		}
	})
	
	function update_scores(world, reset) {
		if (reset) {
			initial_scene();
			return;
		}
		
		var mock = "<li style=\"color: pl_color;\" tabindex=\"pl_id\">pl_name<span class\"key\">pl_score</span></li>";
		var list = $("#player_list");
		var players = world.players.slice();
		list.children().detach();
		
		players.sort(function (a,b) {return b.score - a.score;});
		
		for(var l = 0; l < players.length; l++) {
			var player = players[l];
			var value = mock.replace("pl_id", l);
			value = value.replace("pl_name", player.name);
			value = value.replace("pl_score", player.score);
			value = value.replace(/pl_color/gi, player.color);
			list.append(value);
		}
		$('#info_text').text("Round: " + world.round + " of " + players.length*2);
	}

	function initial_scene() {
		var names = ["Fred", "Greenle", "Pinkney", "Bluebell", "Willem", "Greydon"];
		var colors = ["red", "green", "pink", "blue", "orange", "grey"];
		var mock = "<li style=\"opacity: 0.7;color: pl_color;\" tabindex=\"pl_id\">pl_name<span class\"key\"></span><span class\"key\"></span></li>";
		var players = new Array();
		var list = $("#player_list");
		list.children().detach();
		for(var l = 0; l < colors.length; l++) {
			var value = mock.replace("pl_id", l);
			value = value.replace("pl_name", names[l]);
			value = value.replace(/pl_color/gi, colors[l]);
			list.append(value);
		}

		var selected = {index:0, side:0, player:null};
		
		var lock = false;
		$('#player_list li').click(function(e) {
			if(!lock) {
				lock = true;
				selected.index = parseInt($(this).attr("tabindex"));
				$('#player_list li').eq(selected.index).children().andSelf().css('opacity', 1.0);
				var el = $(this).find('span');
				el.eq(0).text("Press left key").css("color", "yellow").selectText();
				selected.side = "left";
				selected.player = {
					name: names[selected.index],
					color: colors[selected.index],
					left:0,
					right:0
				};
			}
		});
		// Care about the actual keyinput
		var start = true;
		$(document).keydown(function(e) {
			var code = e.keyCode || e.which;
			if(code == 32) {//Start the game
				if(!start || players.length < 2)
					return;
				start = false;
				var stage = $("#stage");
				var width = parseInt(stage.css("width").replace(/[^0-9]+/g, ''));
				var height = parseInt(stage.css("height").replace(/[^0-9]+/g, ''));
				var elem = $("<canvas id='canvas' width=" + width + " height=" + height + "></canvas>");
				stage.html(elem);

				var canvas = elem.get(0);
				if(!canvas.getContext) {
					alert("Canvas not supported!");
					return;
				}

				play(canvas.getContext('2d'), players, update_scores);
				e.preventDefault();
			} else if(lock) {// Assign key to a user
				var el = $('#player_list li').eq(selected.index);
				if(selected.side == "left") {
					el.find('span').eq(0).text(String.fromCharCode(code)).css('color', 'white');
					el.find('span').eq(1).text("Press right key").css("color", "yellow").selectText();
					selected.player.left = code;
					selected.side = "right";
					e.preventDefault();
				} else if(selected.side == "right") {
					el.find('span').eq(1).css('color', 'white').text(String.fromCharCode(code));
					selected.player.right = code;
					
					if ( players.length == 0)
						players.push(selected.player);
						
					for (var i=0; i < players.length; i++) {
						var player = players[i];
						if (player.name == selected.player.name){ 
							players[i] = selected.player;
							break;
						} else if ((i + 1) == players.length) {
							players.push(selected.player);
						}
					};
					
					lock = false;
					e.preventDefault();
				}
			}
		});
	}

	$(document).ready(function() {
		initial_scene();
	});

</script>
#{/set} #{set 'moreStyles'}
<style>
	body, html {
		width: 100%;
		margin: 0;
		padding: 0;
		overflow: hidden;
		font-family: Arial;
		font-size: 20px;
		background-color: black;
		color: white;
		margin: 0;
	}
	#stage {
		border: 2px solid yellow;
		margin: 5px auto;
		position: relative;
		width: 700px;
		height: 700px;
		float: left;
		margin-left: 20px;
	}
	#controls {
		position: relative;
		float: left;
		color: white;
		margin-left: 25px;
		width: 500px;
	}
	#player_list {
		border: 1px white solid;
		padding: 1px;
	}
	#player_list li {
		padding: 10px;
	}
	#player_list li:nth-child(even) {
		background-color: #A8A8A8;
	}
	#player_list li span {
		width:30px;
		margin: 0 0 0 30px;
		color: white;
	}
</style>
#{/set} <div id="stage"></div>
<div id="controls">
	<h4>Achtung die Kurve!</h4>
	<div id="info_text">Click on player to activate</div>
	<form>
		<ul id="player_list" style="list-style: none;"></ul>
		<div style="clear: right;"></div>
	</form>
	<div id="start_msg">
		Press Space to start
	</div>
</div>
<div style="clear: left;"></div>
